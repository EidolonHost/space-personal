{% extends 'grid.html' %}
{% block title %}Space - The Virtualization Control Panel{% endblock %}
{% block head_content %}
<script type="text/javascript">
    getData();

    function getData() {
        $.get("http://pluto.pettitservers.com:10051/ajax/get_host_stats", function(resp) {
            memory = resp['memory']
            cpu = resp['cpu']
            dates = resp['dates']
            iowait = resp['iowait']
            
            makeMemory();
            makeCPU();
            makeIOwait();
        });
    };

    function makeMemory() {
       $('#memory').highcharts({
        title: {
            text: ""
        },
        yAxis: {
            title: {
                text: 'Memory Used (KiB)'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            valueSuffix: 'KiB'
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            borderWidth: 0
        },
        series: [{
            name: 'Memory (KiB)',
            data: memory
        }]
    }); 
    };

    function makeCPU() {
       $('#cpu').highcharts({
        title: {
            text: ""
        },
        yAxis: {
            title: {
                text: 'CPU Used (%)'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            valueSuffix: '%'
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            borderWidth: 0
        },
        series: [{
            name: 'CPU (%)',
            data: cpu
        }]
    });
    };

    function makeIOwait() {
       $('#iowait').highcharts({
        title: {
            text: ""
        },
        yAxis: {
            title: {
                text: 'IOWait (%)'
            },
            plotLines: [{
                value: 0,
                width: 1,
                color: '#808080'
            }]
        },
        tooltip: {
            valueSuffix: '%'
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle',
            borderWidth: 0
        },
        series: [{
            name: 'IOWait (%)',
            data: cpu
        }]
    });
    };


</script>
{% endblock %}
{% block content %}
<h3>VMs</h3>
<table class="table sortable">
    <thead>
    <tr>
        <th>Name</th>
        <th>RAM</th>
        <th>VCPU</th>
        <th>Disk Size</th>
        <th>Image</th>
        <th>State</th>
        <th>Flags</th>
        <th>Actions</th>
    </tr>
    </thead>
    {% for server in servers %}
    <tr>
        <td><a href="/edit/{{ server['_id'] }}">{{ server['name'] }}</a></td>
        <td>{{ server['ram'] }}</td>
        <td>{{ server['vcpu'] }}</td>
        <td>{{ server['disk_size'] }}</td>
        <td>{{ server['disk_image'] }}</td>
        <td>
        {% if server['state'] == 1 %}
        <p><span class="label label-success">Running</span></p>
        {% else %}
        <p><span class="label label-danger">Shutdown</span></p>
        {% endif %}
        </td>
        <td>
        {% if server['inconsistent'] == 1 %}
        <span class="glyphicon glyphicon-exclamation-sign" data-toggle="tooltip" data-placement="right" title="Server is in an inconsistent state"></span>
        {% endif %}
        </td>
        <td>
        {% if server['state'] == 1 %}
        <a class="btn btn-warning btn-xs" href="/shutdown/{{ server['_id'] }}">Shutdown</a>&nbsp;
        <a class="btn btn-warning btn-xs" href="/reboot/{{ server['_id'] }}">Reboot</a>&nbsp;
        <a class="btn btn-primary btn-xs" href="/console/{{ server['_id'] }}">Console</a>&nbsp;
        {% elif server['state'] == 0 %}
        <a class="btn btn-success btn-xs" href="/start/{{ server['_id'] }}">Start</a>&nbsp;
        {% endif %}
        <a class="btn btn-danger btn-xs" href="/destroy/{{ server['_id'] }}">Destroy</a></td>
    </tr>
    {% endfor %}
</table>
<hr/>
<div class="row">
    <div class="col-md-6">
        <h3>Make a New VM</h3>
        <form action="/create" method="post" data-toggle="validator" role="form">
            <div class="form-group">
                <label for="name" class="control-label">VM Name</label>
                <input class="form-control" type="text" name="name" placeholder="VM Name" required/>
                <span class="help-block with-errors"></span>
            </div>
            <div class="form-group">
                <label for="ram" class="control-label">RAM Amount (MB)</label>
                <input class="form-control" type="number" name="ram" placeholder="RAM in MB" required data-type="number" min="1"/>
                <span class="help-block with-errors"></span>
            </div>
            <div class="form-group">
                <label for="disk_size" class="control-label">Disk Size (GB)</label>
                <input class="form-control" type="number" name="disk_size" placeholder="Disk Size in GB" required data-type="number" min="1"/>
                <span class="help-block with-errors"></span>
            </div>
            <div class="form-group">
                <label for="vcpu" class="control-label">vCPUs</label>
                <input class="form-control" type="number" name="vcpu" placeholder="Number of VCPUs" required data-type="number" min="1"/>
                <span class="help-block with-errors"></span>
            </div>
            <div class="form-group">
                <label for="image" class="control-label">Distribution Image</label>
                <select class="form-control" name="image" required>
                {% for image in images %}
                    <option value="{{ image['_id'] }}">{{ image['name'] }}</option>
                {% endfor %}
                </select>
            </div>
                <input class="btn btn-success" type="submit" value="Make it"/>
        </form>
    </div>
    <div class="col-md-6">
        <h3>CPU Statistics</h3>
        <div style="text-align:right;"><strong>CPU Used: {{ stats[0]['cpu'] }}%</strong><br/></div>
        <div id="cpu"></div>
    </div>
</div><!-- row !-->
<hr/>
<div class="row">
    <div class="col-md-6">
        <h3>Memory Stats</h3>
        Total Memory: {{ stats[0]['total_memory'] }}<br/>
        Used Memory: {{ stats[0]['memory_used'] }}<br/>
        <div id="memory"></div>
    </div>
    <div class="col-md-6">
    <h3>IOWait</h3>
    IOWait: {{ stats[0]['iowait'] }}<br/>
    <div id="iowait"></div>
    </div>
</div>
<h3>Error / Warning Events</h3>
<table class="table sortable">
    <thead>
    <tr>
        <th>Date</th>
        <th>Level</th>
        <th>Message</th>
    </tr>
    </thead>
    {% for event in log %}
    <tr>
        <td>{{ event.date }}</td>
        <td>
        {% if event['level'] == 1 %}
        <p><span class="label label-primary">Debug</span></p>
        {% elif event['level'] == 2 %}
        <p><span class="label label-warning">Warning</span></p>
        {% else %}
        <p><span class="label label-danger">Error</span></p>
        {% endif %}
        </td>
        <td>{{ event['message'] }}</td>
    </tr>
    {% endfor %}
</table>
{% endblock %}
